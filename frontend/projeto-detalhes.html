<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalhes do Projeto - IncentivaBR</title>
  <meta name="description" content="Detalhes do projeto social para destinacao via incentivo fiscal.">
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/incentivabr-theme.css">
  <style>
    body {
      background: var(--background-light);
    }

    .hero {
      height: 320px;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 80px;
      position: relative;
    }

    .hero img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .hero-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 48px;
      background: linear-gradient(transparent, rgba(0,0,0,0.75));
      color: white;
    }

    .hero-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 24px;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .hero-title {
      font-size: 36px;
      font-weight: 700;
      line-height: 1.3;
    }

    .hero-org {
      opacity: 0.9;
      margin-top: 12px;
      font-size: 16px;
    }

    .content-grid {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 32px;
    }

    .card {
      background: white;
      border-radius: var(--radius-xl);
      padding: 28px;
      box-shadow: var(--shadow-md);
      margin-bottom: 24px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--primary-color);
    }

    .card-title i {
      color: var(--secondary-color);
    }

    .sidebar {
      position: sticky;
      top: 100px;
    }

    .donate-card {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
      color: white;
      border-radius: var(--radius-xl);
      padding: 28px;
      text-align: center;
    }

    .donate-card h3 {
      font-size: 22px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .progress-large {
      margin: 24px 0;
    }

    .progress-bar-large {
      height: 14px;
      background: rgba(255,255,255,0.25);
      border-radius: 7px;
      overflow: hidden;
    }

    .progress-fill-large {
      height: 100%;
      background: linear-gradient(90deg, var(--secondary-color), var(--warning-color));
      border-radius: 7px;
    }

    .progress-stats {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      font-size: 14px;
      opacity: 0.9;
    }

    .amount-large {
      font-size: 32px;
      font-weight: 700;
      margin: 20px 0 8px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 24px;
    }

    .stat-item {
      text-align: center;
      padding: 14px 8px;
      background: rgba(255,255,255,0.12);
      border-radius: var(--radius-md);
    }

    .stat-value {
      font-size: 22px;
      font-weight: 700;
    }

    .stat-label {
      font-size: 11px;
      opacity: 0.8;
      margin-top: 4px;
    }

    .btn-donate {
      background: var(--success-color);
      color: white;
      width: 100%;
      margin-top: 24px;
      padding: 18px;
      font-size: 18px;
      border-radius: var(--radius-lg);
    }

    .btn-donate:hover {
      background: #008a47;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 168, 89, 0.4);
    }

    .btn-calc-outline {
      background: transparent;
      border: 2px solid white;
      color: white;
      width: 100%;
      margin-top: 12px;
      padding: 14px;
      border-radius: var(--radius-md);
    }

    .btn-calc-outline:hover {
      background: rgba(255,255,255,0.15);
    }

    .tabs {
      display: flex;
      border-bottom: 2px solid var(--border-color);
      margin-bottom: 24px;
    }

    .tab {
      padding: 14px 24px;
      cursor: pointer;
      font-weight: 500;
      color: var(--text-secondary);
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      transition: all 0.3s;
    }

    .tab:hover {
      color: var(--primary-color);
    }

    .tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--secondary-color);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .description {
      line-height: 1.9;
      color: var(--text-secondary);
    }

    .org-info {
      display: flex;
      gap: 20px;
      align-items: flex-start;
    }

    .org-logo {
      width: 80px;
      height: 80px;
      background: var(--background-light);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      color: var(--text-muted);
    }

    .org-details h4 {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--primary-color);
    }

    .org-details p {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 4px;
    }

    .fund-info {
      background: var(--background-light);
      padding: 20px;
      border-radius: var(--radius-lg);
      border-left: 4px solid var(--secondary-color);
    }

    .fund-info h4 {
      font-size: 16px;
      color: var(--primary-color);
      margin-bottom: 12px;
    }

    .fund-info p {
      font-size: 14px;
      margin-bottom: 6px;
      color: var(--text-secondary);
    }

    .bank-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .bank-item {
      background: white;
      padding: 12px;
      border-radius: var(--radius-md);
    }

    .bank-item strong {
      display: block;
      color: var(--text-muted);
      font-size: 11px;
      margin-bottom: 4px;
      text-transform: uppercase;
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: var(--radius-xl);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--primary-color);
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: var(--text-muted);
      padding: 0;
      line-height: 1;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      padding: 24px;
      border-top: 1px solid var(--border-color);
    }

    .info-box {
      background: rgba(0, 168, 89, 0.1);
      padding: 16px;
      border-radius: var(--radius-md);
      margin-bottom: 20px;
      border: 1px solid var(--success-color);
    }

    .info-box.warning {
      background: rgba(255, 184, 0, 0.1);
      border-color: var(--warning-color);
    }

    .success-message {
      text-align: center;
      padding: 40px 20px;
    }

    .success-message i {
      font-size: 72px;
      color: var(--success-color);
      margin-bottom: 20px;
    }

    .success-message h3 {
      font-size: 26px;
      margin-bottom: 12px;
      color: var(--text-primary);
    }

    .loading {
      text-align: center;
      padding: 80px 20px;
    }

    .loading i {
      font-size: 56px;
      color: var(--primary-color);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 900px) {
      .content-grid {
        grid-template-columns: 1fr;
      }

      .sidebar {
        position: static;
      }

      .hero {
        height: 240px;
      }

      .hero-title {
        font-size: 28px;
      }

      .hero-overlay {
        padding: 32px 20px;
      }
    }

    /* Modal de Doação com Dados Bancários */
    .modal-doacao-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(4px);
    }

    .modal-doacao-content {
      background: white;
      padding: 2rem;
      border-radius: 16px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .close-modal-doacao {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 1.75rem;
      cursor: pointer;
      color: #999;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .close-modal-doacao:hover {
      background: #f0f0f0;
      color: #333;
    }

    .btn-copiar-pix:hover {
      background: #1565c0 !important;
      transform: translateY(-1px);
    }

    .btn-ja-fiz-pagamento:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 168, 89, 0.4);
    }

    @media (max-width: 480px) {
      .modal-doacao-content {
        width: 95%;
        padding: 1.5rem;
        margin: 1rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <a href="index.html" class="logo-link">
      <img src="assets/logo-incentivabr.png" alt="IncentivaBR" class="logo-img">
    </a>
    <nav>
      <a href="projetos.html">Projetos</a>
      <a href="calculadora-escolha.html">Calculadora</a>
      <a href="como-funciona.html">Como Funciona</a>
      <a href="#" id="navAuth">Entrar</a>
    </nav>
  </header>

  <div id="pageContent">
    <div class="loading">
      <i class="fas fa-spinner"></i>
      <p style="margin-top:24px;color:var(--text-secondary)">Carregando projeto...</p>
    </div>
  </div>

  <!-- Modal de Destinacao Antigo (mantido para compatibilidade) -->
  <div class="modal-overlay" id="donateModal">
    <div class="modal">
      <div class="modal-header">
        <h2><i class="fas fa-hand-holding-heart"></i> Fazer Destinacao</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Conteudo dinamico -->
      </div>
    </div>
  </div>

  <!-- Modal de Destinacao com Dados Bancários -->
  <div id="modal-doacao" class="modal-doacao-overlay" style="display: none;">
    <div class="modal-doacao-content">
      <span class="close-modal-doacao" onclick="fecharModalDoacao()">&times;</span>

      <!-- Step 1: Dados Bancários -->
      <div id="step-dados-bancarios">
        <h2 style="color: #1E3A5F; margin-bottom: 1rem;"><i class="fas fa-hand-holding-usd"></i> Fazer Destinação</h2>

        <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <p style="margin: 0; color: #2e7d32; font-weight: bold; font-size: 1.1rem;">
            <i class="fas fa-check-circle"></i> Valor da destinação: <span id="modal-valor-doacao">R$ 0,00</span>
          </p>
          <p style="margin: 0.5rem 0 0; font-size: 0.9rem; color: #555;">
            Projeto: <span id="modal-projeto-nome"></span>
          </p>
        </div>

        <h3 style="color: #1E3A5F; font-size: 1rem; margin: 1.5rem 0 0.75rem;">
          <i class="fas fa-university"></i> Dados para Depósito/PIX
        </h3>

        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; font-size: 0.95rem; border: 1px solid #e0e0e0;">
          <p style="margin: 0 0 0.5rem;"><strong>Favorecido:</strong> <span id="modal-beneficiary-name">-</span></p>
          <p style="margin: 0 0 0.5rem;"><strong>CNPJ:</strong> <span id="modal-beneficiary-cnpj">-</span></p>
          <p style="margin: 0 0 0.5rem;"><strong>Banco:</strong> <span id="modal-bank-name">-</span></p>
          <p style="margin: 0 0 0.5rem;"><strong>Agência:</strong> <span id="modal-bank-agency">-</span></p>
          <p style="margin: 0;"><strong>Conta:</strong> <span id="modal-bank-account">-</span></p>

          <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #90caf9;">
            <p style="margin: 0; font-weight: bold; color: #1565c0; font-size: 1rem;">
              <i class="fas fa-key"></i> Chave PIX: <span id="modal-pix-key" style="font-family: monospace;">-</span>
            </p>
            <button onclick="copiarPix()" class="btn-copiar-pix" style="margin-top: 0.75rem; padding: 0.6rem 1.2rem; background: #1976d2; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background 0.2s;">
              <i class="fas fa-copy"></i> Copiar Chave PIX
            </button>
          </div>
        </div>

        <div style="background: #fff8e1; padding: 1rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #ffc107;">
          <p style="margin: 0; font-size: 0.9rem; color: #f57c00;">
            <i class="fas fa-exclamation-triangle"></i> <strong>Importante:</strong> Faça o PIX ou transferência para os dados acima.
            Após realizar o depósito, clique no botão abaixo para confirmar sua destinação.
          </p>
        </div>

        <button onclick="mostrarStepConfirmacao()" class="btn-ja-fiz-pagamento" style="width: 100%; margin-top: 1.5rem; padding: 1rem; background: linear-gradient(135deg, #00A859 0%, #00873d 100%); color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; font-weight: bold; transition: transform 0.2s, box-shadow 0.2s;">
          <i class="fas fa-check"></i> JÁ FIZ O DEPÓSITO
        </button>

        <button onclick="fecharModalDoacao()" style="width: 100%; margin-top: 0.5rem; padding: 0.75rem; background: transparent; color: #666; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: background 0.2s;">
          Cancelar
        </button>
      </div>

      <!-- Step 2: Confirmação -->
      <div id="step-confirmacao" style="display: none;">
        <h2 style="color: #1E3A5F; margin-bottom: 1rem;"><i class="fas fa-file-upload"></i> Confirmar Destinação</h2>

        <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
          <p style="margin: 0; color: #2e7d32; font-size: 1.1rem;">
            <i class="fas fa-donate"></i> Valor: <strong id="confirm-valor">R$ 0,00</strong>
          </p>
        </div>

        <div style="margin-bottom: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">
            <i class="fas fa-paperclip"></i> Anexar Comprovante (opcional, mas recomendado)
          </label>
          <input type="file" id="input-comprovante" accept="image/*,.pdf"
                 style="width: 100%; padding: 0.75rem; border: 2px dashed #ccc; border-radius: 8px; cursor: pointer; background: #fafafa;">
          <p style="font-size: 0.8rem; color: #888; margin-top: 0.5rem;">
            <i class="fas fa-info-circle"></i> Formatos aceitos: JPG, PNG, PDF (máx. 5MB)
          </p>
        </div>

        <div style="margin-bottom: 1.5rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">
            <i class="fas fa-comment-alt"></i> Observações (opcional)
          </label>
          <textarea id="input-observacoes" rows="2" placeholder="Ex: PIX realizado às 14:30 do dia 22/01"
                    style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 8px; resize: vertical; font-family: inherit;"></textarea>
        </div>

        <button onclick="confirmarDoacaoNovo()" id="btn-confirmar-doacao"
                style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #00A859 0%, #00873d 100%); color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; font-weight: bold;">
          <i class="fas fa-check-circle"></i> CONFIRMAR DOAÇÃO
        </button>

        <button onclick="voltarStepDados()" style="width: 100%; margin-top: 0.5rem; padding: 0.75rem; background: transparent; color: #666; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
          <i class="fas fa-arrow-left"></i> Voltar
        </button>
      </div>

      <!-- Step 3: Sucesso -->
      <div id="step-sucesso" style="display: none; text-align: center; padding: 1rem 0;">
        <div style="font-size: 5rem; margin-bottom: 1rem; color: #00A859;">
          <i class="fas fa-check-circle"></i>
        </div>
        <h2 style="color: #00A859; margin-bottom: 1rem;">Destinação Registrada!</h2>
        <p style="color: #555; margin-bottom: 1rem; font-size: 1.1rem;">
          Sua destinação de <strong id="sucesso-valor">R$ 0,00</strong> foi registrada com sucesso.
        </p>
        <div style="background: #fff8e1; padding: 0.75rem 1rem; border-radius: 8px; display: inline-block; margin-bottom: 1.5rem;">
          <span style="color: #f57c00; font-weight: 500;">
            <i class="fas fa-clock"></i> Status: Aguardando confirmação
          </span>
        </div>
        <p style="font-size: 0.9rem; color: #888; margin-bottom: 2rem;">
          O administrador do fundo irá verificar o depósito e confirmar sua destinação em até 48 horas úteis.
        </p>
        <button onclick="window.location.href='dashboard.html'"
                style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #1E3A5F 0%, #2c5282 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; font-weight: 500;">
          <i class="fas fa-tachometer-alt"></i> Ver Minhas Destinações
        </button>
        <button onclick="fecharModalDoacao()"
                style="width: 100%; margin-top: 0.5rem; padding: 0.75rem; background: transparent; color: #666; border: 1px solid #ddd; border-radius: 8px; cursor: pointer;">
          Fechar
        </button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <a href="index.html" class="logo-link">
      <img src="assets/logo-incentivabr.png" alt="IncentivaBR" class="logo-img logo-white">
    </a>
    <p class="tagline">Incentivos Fiscais Simplificados</p>
    <div class="footer-bottom">
      <p>
        <a href="politica-privacidade.html" style="color: rgba(255,255,255,0.8);">Politica de Privacidade</a> |
        <a href="termos-uso.html" style="color: rgba(255,255,255,0.8);">Termos de Uso</a>
      </p>
      <p style="margin-top: 12px;">&copy; 2026 IncentivaBR. Todos os direitos reservados.</p>
      <p style="margin-top: 8px; font-size: 12px;">INPI: BR512025000647-0</p>
    </div>
  </footer>

  <script src="js/auth.js"></script>
  <script src="js/mobile-menu.js"></script>
  <script src="js/api.js"></script>
  <script src="js/utils.js"></script>
  <script>
    // Update nav
    const navAuth = document.getElementById('navAuth');
    if (auth.isLoggedIn()) {
      const user = auth.getUser();
      navAuth.textContent = user.nome ? user.nome.split(' ')[0] : 'Minha Conta';
      navAuth.href = 'dashboard.html';
    } else {
      navAuth.href = 'login.html';
    }

    let project = null;
    let irData = auth.getIRData();

    const fundColors = {
      children: '#00A859', elderly: '#2B5A9E', culture: '#9C27B0', sports: '#F7941D',
      audiovisual: '#E91E63', recycling: '#00BCD4', health_oncology: '#E74C3C', health_pcd: '#3F51B5'
    };

    // Load project
    async function loadProject() {
      const projectId = utils.getQueryParam('id');
      if (!projectId) {
        window.location.href = 'projetos.html';
        return;
      }

      try {
        const response = await api.getProject(projectId);
        project = response.project;
        renderProject();
      } catch (error) {
        document.getElementById('pageContent').innerHTML = `
          <div class="container" style="text-align:center;padding:80px 20px">
            <i class="fas fa-exclamation-circle" style="font-size:72px;color:var(--danger-color)"></i>
            <h2 style="margin:24px 0;color:var(--text-primary)">Projeto nao encontrado</h2>
            <p style="color:var(--text-secondary);margin-bottom:24px">O projeto que voce procura nao existe ou foi removido.</p>
            <a href="projetos.html" class="btn btn-primary">Ver Projetos</a>
          </div>
        `;
      }
    }

    function renderProject() {
      const color = fundColors[project.fund.fund_type] || '#607D8B';
      const daysLeft = project.days_remaining;

      document.title = `${project.title} - IncentivaBR`;

      document.getElementById('pageContent').innerHTML = `
        <div class="hero" style="background: linear-gradient(135deg, ${color} 0%, ${color}99 100%)">
          ${project.cover_image_url ? `<img src="${project.cover_image_url}" alt="">` : '<i class="fas fa-hand-holding-heart"></i>'}
          <div class="hero-overlay">
            <span class="hero-badge" style="background:${color}">${project.fund.name}</span>
            <h1 class="hero-title">${project.title}</h1>
            <p class="hero-org"><i class="fas fa-building"></i> ${project.organization.name}</p>
          </div>
        </div>

        <div class="container" style="padding-top: 32px; padding-bottom: 60px;">
          <div class="content-grid">
            <div class="main-content">
              <div class="card">
                <div class="tabs">
                  <div class="tab active" data-tab="about">Sobre o Projeto</div>
                  <div class="tab" data-tab="org">Organizacao</div>
                  <div class="tab" data-tab="fund">Fundo</div>
                </div>

                <div class="tab-content active" id="tab-about">
                  <p class="description">${project.description}</p>
                </div>

                <div class="tab-content" id="tab-org">
                  <div class="org-info">
                    <div class="org-logo"><i class="fas fa-building"></i></div>
                    <div class="org-details">
                      <h4>${project.organization.name}</h4>
                      <p><strong>Nome Legal:</strong> ${project.organization.legal_name || '-'}</p>
                      <p><strong>CNPJ:</strong> ${project.organization.cnpj || '-'}</p>
                      <p><strong>Email:</strong> ${project.organization.email || '-'}</p>
                      <p><strong>Telefone:</strong> ${project.organization.phone || '-'}</p>
                      <p><strong>Status:</strong> ${project.organization.accreditation_status}</p>
                    </div>
                  </div>
                  ${project.organization.description ? `<p style="margin-top:20px;color:var(--text-secondary)">${project.organization.description}</p>` : ''}
                </div>

                <div class="tab-content" id="tab-fund">
                  <div class="fund-info">
                    <h4>${project.fund.name}</h4>
                    <p><strong>Codigo:</strong> ${project.fund.code}</p>
                    <p><strong>Lei Federal:</strong> ${project.fund.federal_law || '-'}</p>
                    <p><strong>Limite deducao:</strong> ${project.fund.max_percentage}% do IR devido</p>
                    <p><strong>Grupo:</strong> ${project.fund.group_name}</p>

                    ${project.fund.bank_code ? `
                      <h4 style="margin-top:20px">Dados Bancarios</h4>
                      <div class="bank-info">
                        <div class="bank-item"><strong>Banco</strong>${project.fund.bank_code}</div>
                        <div class="bank-item"><strong>Agencia</strong>${project.fund.agency || '-'}</div>
                        <div class="bank-item"><strong>Conta</strong>${project.fund.account || '-'}</div>
                        <div class="bank-item"><strong>CNPJ</strong>${project.fund.cnpj || '-'}</div>
                      </div>
                    ` : ''}
                  </div>
                </div>
              </div>
            </div>

            <div class="sidebar">
              <div class="donate-card">
                <h3><i class="fas fa-heart"></i> Apoie este projeto</h3>

                <div class="progress-large">
                  <div class="progress-bar-large">
                    <div class="progress-fill-large" style="width: ${Math.min(project.percentage_raised, 100)}%"></div>
                  </div>
                  <div class="progress-stats">
                    <span>${project.percentage_raised}% arrecadado</span>
                  </div>
                </div>

                <div class="amount-large">${utils.formatCurrency(project.current_amount)}</div>
                <p style="opacity:0.85">de ${utils.formatCurrency(project.goal_amount)}</p>

                <div class="stats-grid">
                  <div class="stat-item">
                    <div class="stat-value">${project.total_donors}</div>
                    <div class="stat-label">Apoiadores</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value">${daysLeft !== null ? daysLeft : '-'}</div>
                    <div class="stat-label">Dias restantes</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value">${utils.formatCurrency(project.amount_remaining)}</div>
                    <div class="stat-label">Faltam</div>
                  </div>
                </div>

                <div id="btn-doar-container">
                  <!-- Preenchido dinamicamente pelo JavaScript -->
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      // Tab functionality
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
        });
      });

      // Atualizar botões de doação baseado no estado do IR
      atualizarBotoesDoacao();
    }

    // Função para atualizar botões de doação baseado no cálculo de IR
    function atualizarBotoesDoacao() {
      const btnContainer = document.getElementById('btn-doar-container');
      if (!btnContainer) return;

      const irData = auth.getIRData();
      const irCalculado = irData && irData.ir_devido;

      if (irCalculado) {
        // Já calculou - mostra botão de doar
        const irDevido = parseFloat(irData.ir_devido);
        const limiteMaximo = irData.limites_doacao ? irData.limites_doacao.total_maximo : (irDevido * 0.09);

        btnContainer.innerHTML = `
          <div style="background: rgba(0,168,89,0.15); border-radius: 12px; padding: 12px 16px; margin-bottom: 16px;">
            <p style="color: #00A859; margin: 0; font-size: 14px;">
              <i class="fas fa-check-circle"></i> IR Calculado: <strong>${utils.formatCurrency(irDevido)}</strong>
            </p>
            <p style="color: #00A859; margin: 4px 0 0 0; font-size: 13px;">
              Limite para destinar: <strong>${utils.formatCurrency(limiteMaximo)}</strong> (${typeof tenant !== 'undefined' ? tenant.getMaxPercentage() : 9}%)
            </p>
          </div>

          <div style="margin-bottom: 12px;">
            <label style="display: block; color: white; font-size: 14px; margin-bottom: 6px;">Valor da destinação:</label>
            <input type="text" id="input-valor-doacao" placeholder="R$ 0,00"
                   style="width: 100%; padding: 12px; border-radius: 8px; border: none; font-size: 18px; text-align: center; font-weight: bold;"
                   oninput="utils.maskCurrency(this)">
            <p style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 4px; text-align: center;">
              Máximo: ${utils.formatCurrency(limiteMaximo)}
            </p>
          </div>

          <button class="btn btn-donate" onclick="iniciarDoacao()">
            <i class="fas fa-hand-holding-heart"></i> DESTINAR AGORA
          </button>
          <a href="calculadora-escolha.html" class="btn btn-calc-outline" style="margin-top: 8px; font-size: 13px;">
            <i class="fas fa-sync-alt"></i> Recalcular meu IR
          </a>
        `;
      } else {
        // Não calculou - mostra botão de calcular como principal
        btnContainer.innerHTML = `
          <div style="background: rgba(247,148,29,0.15); border-radius: 12px; padding: 12px 16px; margin-bottom: 16px;">
            <p style="color: #F7941D; margin: 0; font-size: 14px;">
              <i class="fas fa-exclamation-triangle"></i> <strong>Primeiro, descubra quanto você pode destinar!</strong>
            </p>
          </div>
          <button class="btn btn-donate" onclick="irParaCalculadora()" style="background: linear-gradient(135deg, #F7941D 0%, #00A859 100%);">
            <i class="fas fa-calculator"></i> CALCULAR MEU IR
          </button>
          <p style="text-align: center; margin-top: 12px; color: rgba(255,255,255,0.8); font-size: 13px;">
            É rápido! Depois você volta para destinar.
          </p>
          <button class="btn btn-calc-outline" onclick="openDonateModal()" style="margin-top: 8px; font-size: 13px; opacity: 0.8;">
            <i class="fas fa-hand-holding-heart"></i> Já sei meu IR - Quero destinar
          </button>
        `;
      }
    }

    // Função para ir para calculadora salvando projeto atual
    function irParaCalculadora() {
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('id');
      if (projectId) {
        localStorage.setItem('incentivabr_projeto_pendente', projectId);
      }
      window.location.href = 'calculadora-escolha.html';
    }

    // Open donate modal
    function openDonateModal() {
      // Verificar se temos o ID do projeto na URL
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('id');
      if (!projectId) {
        utils.showToast('Erro: ID do projeto não encontrado', 'error');
        return;
      }

      if (!auth.isLoggedIn()) {
        window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
        return;
      }

      irData = auth.getIRData();

      if (!irData || !irData.ir_devido) {
        document.getElementById('modalBody').innerHTML = `
          <div class="info-box warning">
            <p><strong><i class="fas fa-calculator"></i> Calcule seu IR primeiro</strong></p>
            <p style="margin-top:8px">Para fazer uma destinação, você precisa primeiro calcular seu IR na nossa calculadora.</p>
          </div>
          <button onclick="irParaCalculadora()" class="btn btn-primary" style="width:100%">
            <i class="fas fa-calculator"></i> Ir para Calculadora
          </button>
        `;
      } else {
        const maxDonation = irData.limites_doacao.total_maximo;

        document.getElementById('modalBody').innerHTML = `
          <div class="info-box">
            <p><strong>Seu IR devido:</strong> ${utils.formatCurrency(irData.ir_devido)}</p>
            <p><strong>Limite maximo (${typeof tenant !== 'undefined' ? tenant.getMaxPercentage() : 9}%):</strong> ${utils.formatCurrency(maxDonation)}</p>
          </div>

          <form id="donateForm">
            <div class="form-group">
              <label for="donationAmount">Valor da destinacao</label>
              <input type="text" id="donationAmount" placeholder="R$ 0,00" required style="padding:14px 16px;border:2px solid var(--border-color);border-radius:var(--radius-md);width:100%;font-size:16px">
              <p style="font-size:13px;color:var(--text-muted);margin-top:8px">Maximo: ${utils.formatCurrency(maxDonation)}</p>
            </div>

            <button type="submit" class="btn btn-success" style="width:100%" id="confirmDonateBtn">
              <i class="fas fa-check"></i> Confirmar Destinacao
            </button>
          </form>
        `;

        // Mask
        document.getElementById('donationAmount').addEventListener('input', function() {
          utils.maskCurrency(this);
        });

        // Form submit
        document.getElementById('donateForm').addEventListener('submit', handleDonation);
      }

      document.getElementById('donateModal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('donateModal').classList.remove('show');
    }

    async function handleDonation(e) {
      if (e) e.preventDefault();

      try {
        // 1. PEGAR PROJECT_ID DA URL (método garantido)
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');

        console.log('=== DOAÇÃO ===');
        console.log('Project ID:', projectId);

        if (!projectId) {
          utils.showToast('Erro: ID do projeto não encontrado', 'error');
          return;
        }

        // 2. PEGAR VALORES DO FORMULÁRIO
        const amount = utils.parseCurrency(document.getElementById('donationAmount').value);
        const irDevido = irData?.ir_devido || 0;
        const anoFiscal = irData?.fiscal_year || 2026;

        console.log('Valores:', { amount, irDevido, anoFiscal });

        // 3. VALIDAÇÕES
        if (!irDevido || irDevido <= 0) {
          utils.showToast('Erro: IR devido não encontrado. Recalcule seu IR.', 'error');
          return;
        }

        if (!amount || amount <= 0) {
          utils.showToast('Informe o valor da destinação', 'warning');
          return;
        }

        const maxPercent = typeof tenant !== 'undefined' ? tenant.getMaxPercentage() : 9;
        const limiteMaximo = irDevido * (maxPercent / 100);
        if (amount > limiteMaximo) {
          utils.showToast(`Valor máximo: ${utils.formatCurrency(limiteMaximo)} (${maxPercent}% do IR)`, 'warning');
          return;
        }

        // 4. PEGAR TOKEN (usa auth.getToken() que busca de 'incentivabr_token')
        const token = auth.getToken();
        if (!token) {
          utils.showToast('Faça login para continuar', 'warning');
          window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
          return;
        }

        // 5. MOSTRAR LOADING
        const btn = document.getElementById('confirmDonateBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';

        // 6. PREPARAR DADOS
        const donationData = {
          project_id: projectId,
          ir_total: irDevido,
          donation_amount: amount,
          fiscal_year: anoFiscal
        };

        console.log('Enviando para API:', donationData);

        // 7. ENVIAR PARA API (fetch direto para debug)
        const response = await fetch('/api/donations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(donationData)
        });

        const result = await response.json();
        console.log('Resposta:', response.status, result);

        // 8. PROCESSAR RESPOSTA
        if (response.ok && result.status === 'success') {
          const projectTitle = project?.title || 'Projeto';

          document.getElementById('modalBody').innerHTML = `
            <div class="success-message">
              <i class="fas fa-check-circle"></i>
              <h3>Destinação Registrada!</h3>
              <p style="color:var(--text-secondary);margin-bottom:24px">Sua destinação de ${utils.formatCurrency(amount)} foi registrada com sucesso.</p>
              <p style="font-size:14px;color:var(--text-secondary)">Projeto: ${projectTitle}</p>
              <a href="dashboard.html" class="btn btn-primary" style="margin-top:24px">
                Ver Minhas Destinações
              </a>
            </div>
          `;

          // Reload project to update values
          setTimeout(() => loadProject(), 2500);

        } else {
          const errorMsg = result.message || 'Erro ao processar destinação';
          utils.showToast(errorMsg, 'error');
          console.error('Erro da API:', result);
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-check"></i> Confirmar Destinação';
        }

      } catch (error) {
        console.error('Erro completo:', error);
        utils.showToast('Erro ao processar destinação: ' + error.message, 'error');
        const btn = document.getElementById('confirmDonateBtn');
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-check"></i> Confirmar Destinação';
        }
      }
    }

    // Close modal on overlay click
    document.getElementById('donateModal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('donateModal')) closeModal();
    });

    // ========== NOVO MODAL DE DOAÇÃO COM DADOS BANCÁRIOS ==========

    let dadosDoacaoAtual = {
      projectId: null,
      valor: 0,
      projeto: null
    };

    // Função chamada pelo botão "DOAR AGORA"
    function iniciarDoacao() {
      // Verificar login
      if (!auth.isLoggedIn()) {
        window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
        return;
      }

      // Pegar valor do input
      const inputValor = document.getElementById('input-valor-doacao');
      if (!inputValor || !inputValor.value) {
        utils.showToast('Digite o valor da destinação', 'warning');
        inputValor?.focus();
        return;
      }

      const valor = utils.parseCurrency(inputValor.value);
      if (!valor || valor <= 0) {
        utils.showToast('Valor inválido', 'warning');
        return;
      }

      // Validar limite
      const irData = auth.getIRData();
      const limiteMaximo = irData?.limites_doacao?.total_maximo || (irData?.ir_devido * 0.09) || 0;
      if (valor > limiteMaximo) {
        utils.showToast(`Valor máximo permitido: ${utils.formatCurrency(limiteMaximo)}`, 'warning');
        return;
      }

      // Abrir novo modal com dados bancários
      abrirModalDoacaoNovo(valor);
    }

    function abrirModalDoacaoNovo(valor) {
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('id');

      dadosDoacaoAtual.projectId = projectId;
      dadosDoacaoAtual.valor = valor || 0;

      // Buscar dados do projeto com dados bancários
      fetch(`/api/projects/${projectId}`)
        .then(r => r.json())
        .then(data => {
          if (data.status === 'success' && data.project) {
            const proj = data.project;
            dadosDoacaoAtual.projeto = proj;

            // Usar dados bancarios do projeto, ou fallback para organizacao
            const org = typeof tenant !== 'undefined' ? tenant.getBankData() : null;
            const bankData = proj.pix_key ? proj : (org || proj);

            // Preencher modal
            document.getElementById('modal-valor-doacao').textContent =
              'R$ ' + dadosDoacaoAtual.valor.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('modal-projeto-nome').textContent = proj.title;
            document.getElementById('modal-beneficiary-name').textContent = bankData.beneficiary_name || proj.beneficiary_name || 'Fundo de Incentivo Fiscal';
            document.getElementById('modal-beneficiary-cnpj').textContent = bankData.beneficiary_cnpj || proj.beneficiary_cnpj || '-';
            document.getElementById('modal-bank-name').textContent = bankData.bank_name || proj.bank_name || '-';
            document.getElementById('modal-bank-agency').textContent = bankData.bank_agency || proj.bank_agency || '-';
            document.getElementById('modal-bank-account').textContent = bankData.bank_account || proj.bank_account || '-';
            document.getElementById('modal-pix-key').textContent = bankData.pix_key || proj.pix_key || '-';

            // Mostrar modal
            document.getElementById('modal-doacao').style.display = 'flex';
            document.getElementById('step-dados-bancarios').style.display = 'block';
            document.getElementById('step-confirmacao').style.display = 'none';
            document.getElementById('step-sucesso').style.display = 'none';
          } else {
            utils.showToast('Erro ao carregar dados do projeto', 'error');
          }
        })
        .catch(err => {
          console.error('Erro ao buscar projeto:', err);
          utils.showToast('Erro ao carregar dados do projeto', 'error');
        });
    }

    function fecharModalDoacao() {
      document.getElementById('modal-doacao').style.display = 'none';
    }

    function copiarPix() {
      const pixKey = document.getElementById('modal-pix-key').textContent;
      if (pixKey && pixKey !== '-') {
        navigator.clipboard.writeText(pixKey).then(() => {
          utils.showToast('Chave PIX copiada! Cole no seu app do banco.', 'success');
        }).catch(() => {
          prompt('Copie a chave PIX:', pixKey);
        });
      }
    }

    function mostrarStepConfirmacao() {
      document.getElementById('step-dados-bancarios').style.display = 'none';
      document.getElementById('step-confirmacao').style.display = 'block';
      document.getElementById('confirm-valor').textContent = document.getElementById('modal-valor-doacao').textContent;
    }

    function voltarStepDados() {
      document.getElementById('step-confirmacao').style.display = 'none';
      document.getElementById('step-dados-bancarios').style.display = 'block';
    }

    async function confirmarDoacaoNovo() {
      const btn = document.getElementById('btn-confirmar-doacao');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
      btn.disabled = true;

      try {
        const token = auth.getToken();
        if (!token) {
          utils.showToast('Faça login para continuar', 'warning');
          window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.href);
          return;
        }

        const irData = auth.getIRData();
        let irTotal = irData?.ir_devido || 15000;

        // 1. Registrar doação
        const response = await fetch('/api/donations', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({
            project_id: dadosDoacaoAtual.projectId,
            ir_total: irTotal,
            donation_amount: dadosDoacaoAtual.valor,
            fiscal_year: 2026
          })
        });

        const result = await response.json();

        if (result.status !== 'success') {
          throw new Error(result.message || 'Erro ao registrar destinação');
        }

        const donationId = result.donation.id;

        // 2. Upload do comprovante (se houver)
        const fileInput = document.getElementById('input-comprovante');
        if (fileInput && fileInput.files.length > 0) {
          const formData = new FormData();
          formData.append('receipt', fileInput.files[0]);

          try {
            await fetch(`/api/uploads/receipt/${donationId}`, {
              method: 'POST',
              headers: {
                'Authorization': 'Bearer ' + token
              },
              body: formData
            });
          } catch (uploadErr) {
            console.warn('Erro no upload do comprovante:', uploadErr);
          }
        }

        // 3. Mostrar sucesso
        document.getElementById('step-confirmacao').style.display = 'none';
        document.getElementById('step-sucesso').style.display = 'block';
        document.getElementById('sucesso-valor').textContent = document.getElementById('modal-valor-doacao').textContent;

        // Atualizar página após 3 segundos
        setTimeout(() => loadProject(), 3000);

      } catch (error) {
        console.error('Erro:', error);
        utils.showToast('Erro ao confirmar destinação: ' + error.message, 'error');
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    // Fechar modal ao clicar fora
    document.getElementById('modal-doacao')?.addEventListener('click', function(e) {
      if (e.target === this) {
        fecharModalDoacao();
      }
    });

    // ========== FIM DO NOVO MODAL ==========

    // Init
    loadProject();
  </script>
  <script src="js/tenant.js"></script>
</body>
</html>

