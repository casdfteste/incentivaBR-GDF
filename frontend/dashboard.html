<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minha Conta - IncentivaBR</title>
  <meta name="description" content="Painel do usuario IncentivaBR.">
  <link rel="icon" type="image/png" href="assets/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/incentivabr-theme.css">
  <style>
    body {
      background: var(--background-light);
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 42px;
      height: 42px;
      background: var(--primary-color);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 16px;
    }

    .btn-logout {
      background: none;
      border: 2px solid var(--danger-color);
      color: var(--danger-color);
      padding: 8px 16px;
      border-radius: var(--radius-md);
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-logout:hover {
      background: var(--danger-color);
      color: white;
    }

    .welcome-section {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
      color: white;
      padding: 48px;
      border-radius: var(--radius-xl);
      margin-bottom: 32px;
    }

    .welcome-section h1 {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .welcome-section p {
      opacity: 0.9;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 32px;
    }

    .stat-card {
      background: rgba(255,255,255,0.15);
      padding: 24px;
      border-radius: var(--radius-lg);
      text-align: center;
    }

    .stat-card .value {
      font-size: 36px;
      font-weight: 700;
    }

    .stat-card .label {
      font-size: 14px;
      opacity: 0.85;
      margin-top: 4px;
    }

    .section {
      margin-bottom: 32px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 22px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--primary-color);
    }

    .section-title i {
      color: var(--secondary-color);
    }

    .card {
      background: white;
      border-radius: var(--radius-xl);
      padding: 28px;
      box-shadow: var(--shadow-md);
    }

    .donation-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .donation-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: var(--background-light);
      border-radius: var(--radius-lg);
      transition: all 0.3s;
    }

    .donation-item:hover {
      transform: translateX(4px);
    }

    .donation-icon {
      width: 52px;
      height: 52px;
      background: linear-gradient(135deg, var(--success-color), #00C969);
      color: white;
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    .donation-info {
      flex: 1;
    }

    .donation-title {
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-primary);
    }

    .donation-meta {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .donation-amount {
      text-align: right;
    }

    .donation-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--success-color);
    }

    .donation-date {
      font-size: 12px;
      color: var(--text-muted);
    }

    .donation-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .btn-download {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.3s;
    }

    .btn-download.comprovante {
      background: var(--primary-color);
      color: white;
    }

    .btn-download.comprovante:hover {
      background: #152d4a;
    }

    .btn-download.recibo {
      background: var(--success-color);
      color: white;
    }

    .btn-download.recibo:hover {
      background: #008a47;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      color: white;
    }

    .badge-pending {
      background: var(--warning-color);
      color: var(--text-primary);
    }

    .badge-confirmed {
      background: var(--info-color);
    }

    .badge-processed {
      background: var(--success-color);
    }

    .empty-state {
      text-align: center;
      padding: 48px 20px;
      color: var(--text-secondary);
    }

    .empty-state i {
      font-size: 56px;
      color: var(--border-color);
      margin-bottom: 20px;
    }

    .actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-top: 24px;
    }

    .action-card {
      background: white;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 28px;
      text-align: center;
      text-decoration: none;
      color: var(--text-primary);
      transition: all 0.3s;
    }

    .action-card:hover {
      border-color: var(--primary-color);
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
    }

    .action-card i {
      font-size: 36px;
      color: var(--primary-color);
      margin-bottom: 16px;
    }

    .action-card h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }

    .action-card p {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .ir-summary {
      background: rgba(0, 168, 89, 0.08);
      padding: 24px;
      border-radius: var(--radius-lg);
      margin-bottom: 24px;
      border: 1px solid var(--success-color);
    }

    .ir-summary h4 {
      color: #006837;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ir-summary h4 i {
      color: var(--success-color);
    }

    .ir-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
    }

    .ir-item {
      background: white;
      padding: 16px;
      border-radius: var(--radius-md);
      text-align: center;
    }

    .ir-item .value {
      font-size: 22px;
      font-weight: 700;
      color: #006837;
    }

    .ir-item .label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .loading {
      text-align: center;
      padding: 48px;
    }

    .loading i {
      font-size: 40px;
      color: var(--primary-color);
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .header nav:not(.user-menu) {
        display: none;
      }

      .welcome-section {
        padding: 28px 20px;
      }

      .welcome-section h1 {
        font-size: 26px;
      }

      .stat-card .value {
        font-size: 28px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <a href="index.html" class="logo-link">
      <img src="assets/logo-incentivabr.png" alt="IncentivaBR" class="logo-img">
    </a>
    <nav>
      <a href="projetos.html">Projetos</a>
      <a href="calculadora-escolha.html">Calculadora</a>
      <a href="como-funciona.html">Como Funciona</a>
    </nav>
    <div class="user-menu">
      <div class="user-avatar" id="userAvatar">?</div>
      <span id="userName" style="font-weight:500">Carregando...</span>
      <button class="btn-logout" onclick="auth.logout()">
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>
    </div>
  </header>

  <div class="container" style="padding-top: 32px; padding-bottom: 60px;">
    <!-- Welcome Section -->
    <div class="welcome-section">
      <h1 id="welcomeTitle">Ola!</h1>
      <p>Acompanhe suas destinacoes e impacto social</p>

      <!-- Link Admin (visivel apenas para admins) -->
      <div id="adminLinkContainer" style="margin: 1.5rem 0; display: none;">
        <a href="admin.html" style="display: inline-block; padding: 0.75rem 1.5rem; background: rgba(255,255,255,0.2); color: white; text-decoration: none; border-radius: 8px; font-weight: bold; border: 2px solid rgba(255,255,255,0.3);">
          <i class="fas fa-chart-bar"></i> Painel Administrativo (Fundo)
        </a>
      </div>

      <div class="stats-row">
        <div class="stat-card">
          <div class="value" id="statTotalDonated">R$ 0</div>
          <div class="label">Total Destinado</div>
        </div>
        <div class="stat-card">
          <div class="value" id="statTotalDonations">0</div>
          <div class="label">Destinacoes</div>
        </div>
        <div class="stat-card">
          <div class="value" id="statIRDue">-</div>
          <div class="label">IR Devido (calculado)</div>
        </div>
      </div>
    </div>

    <!-- IR Summary -->
    <div id="irSummarySection" style="display:none">
      <div class="ir-summary">
        <h4><i class="fas fa-calculator"></i> Seu Calculo IR 2026</h4>
        <div class="ir-grid">
          <div class="ir-item">
            <div class="value" id="irRendimentos">-</div>
            <div class="label">Rendimentos</div>
          </div>
          <div class="ir-item">
            <div class="value" id="irDevido">-</div>
            <div class="label">IR Devido</div>
          </div>
          <div class="ir-item">
            <div class="value" id="irLimite">-</div>
            <div class="label">Limite Destinacao (<span class="max-percentage">9%</span>)</div>
          </div>
          <div class="ir-item">
            <div class="value" id="irDisponivel">-</div>
            <div class="label">Disponivel</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Minhas Destinacoes -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title"><i class="fas fa-hand-holding-heart"></i> Minhas Destinacoes</h2>
        <a href="projetos.html" class="btn btn-outline">
          <i class="fas fa-plus"></i> Nova Destinacao
        </a>
      </div>

      <div class="card">
        <div id="donationsList" class="donation-list">
          <div class="loading">
            <i class="fas fa-spinner"></i>
            <p style="margin-top:16px">Carregando destinacoes...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Acoes -->
    <div class="section">
      <h2 class="section-title"><i class="fas fa-rocket"></i> Continue Destinando</h2>

      <div class="actions-grid">
        <a href="calculadora-escolha.html" class="action-card">
          <i class="fas fa-calculator"></i>
          <h3>Calcular IR 2026</h3>
          <p>Descubra quanto pode destinar</p>
        </a>

        <a href="projetos.html" class="action-card">
          <i class="fas fa-search"></i>
          <h3>Explorar Projetos</h3>
          <p>Encontre causas para apoiar</p>
        </a>

        <a href="projetos.html?is_featured=true" class="action-card">
          <i class="fas fa-star"></i>
          <h3>Projetos em Destaque</h3>
          <p>Os mais apoiados do momento</p>
        </a>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <a href="index.html" class="logo-link">
      <img src="assets/logo-incentivabr.png" alt="IncentivaBR" class="logo-img logo-white">
    </a>
    <p class="tagline">Incentivos Fiscais Simplificados</p>
    <div class="footer-bottom">
      <p>
        <a href="politica-privacidade.html" style="color: rgba(255,255,255,0.8);">Politica de Privacidade</a> |
        <a href="termos-uso.html" style="color: rgba(255,255,255,0.8);">Termos de Uso</a>
      </p>
      <p style="margin-top: 12px;">&copy; 2026 IncentivaBR. Todos os direitos reservados.</p>
      <p style="margin-top: 8px; font-size: 12px;">INPI: BR512025000647-0</p>
    </div>
  </footer>

  <script src="js/auth.js"></script>
  <script src="js/mobile-menu.js"></script>
  <script src="js/api.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/toast.js"></script>
  <script src="js/tina.js"></script>
  <script>
    // Require auth
    if (!auth.requireAuth()) {
      // Will redirect to login
    }

    let user = auth.getUser();
    let irData = auth.getIRData();

    // Update UI with user data
    function updateUserUI() {
      const firstName = user.nome ? user.nome.split(' ')[0] : 'Usuario';
      document.getElementById('userName').textContent = firstName;
      document.getElementById('userAvatar').textContent = firstName.charAt(0).toUpperCase();
      document.getElementById('welcomeTitle').textContent = `Ola, ${firstName}!`;
      document.getElementById('statTotalDonated').textContent = utils.formatCurrency(user.total_donated || 0);

      // Mostrar link admin se usuario for admin
      if (user.is_admin) {
        document.getElementById('adminLinkContainer').style.display = 'block';
      }
    }

    // Load fresh user data
    async function loadUserData() {
      try {
        const response = await api.me();
        user = response.user;
        auth.setUser(user);
        updateUserUI();
      } catch (error) {
        if (error.status === 401) {
          auth.logout();
        }
      }
    }

    // Update IR summary
    function updateIRSummary() {
      if (irData && irData.ir_devido) {
        document.getElementById('irSummarySection').style.display = 'block';
        document.getElementById('statIRDue').textContent = utils.formatCurrency(irData.ir_devido);
        document.getElementById('irRendimentos').textContent = utils.formatCurrency(irData.rendimentos_total);
        document.getElementById('irDevido').textContent = utils.formatCurrency(irData.ir_devido);
        document.getElementById('irLimite').textContent = utils.formatCurrency(irData.limites_doacao?.total_maximo || 0);

        // Calculate available (limite - total donated this year)
        // For now, show the limit
        document.getElementById('irDisponivel').textContent = utils.formatCurrency(irData.limites_doacao?.total_maximo || 0);
      }
    }

    // Helper para labels de status
    function getStatusLabel(status) {
      const labels = {
        'pending': 'Pendente',
        'confirmed': 'Confirmada',
        'rejected': 'Recusada',
        'cancelled': 'Cancelada'
      };
      return labels[status] || status;
    }

    // Funcao para baixar comprovante PDF com autenticacao
    async function baixarComprovante(donationId) {
      const token = localStorage.getItem('incentivabr_token');

      if (!token) {
        alert('Voce precisa estar logado para baixar o comprovante.');
        return;
      }

      try {
        const response = await fetch(`/api/donations/${donationId}/comprovante`, {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || 'Erro ao baixar comprovante');
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `comprovante-destinacao-${donationId.substring(0, 8)}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();

      } catch (error) {
        console.error('Erro ao baixar comprovante:', error);
        alert(error.message || 'Erro ao baixar comprovante. Tente novamente.');
      }
    }

    // Load donations
    async function loadDonations() {
      const container = document.getElementById('donationsList');

      try {
        const response = await api.getMyDonations({ fiscal_year: 2026 });

        document.getElementById('statTotalDonations').textContent = response.summary.total_donations;
        document.getElementById('statTotalDonated').textContent = utils.formatCurrency(response.summary.total_donated);

        if (response.donations.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <i class="fas fa-hand-holding-heart"></i>
              <h3>Nenhuma destinacao ainda</h3>
              <p>Comece a transformar seu imposto em impacto social!</p>
              <a href="projetos.html" class="btn btn-primary" style="margin-top:20px">
                Ver Projetos
              </a>
            </div>
          `;
          return;
        }

        container.innerHTML = response.donations.map(donation => `
          <div class="donation-item">
            <div class="donation-icon">
              <i class="fas fa-heart"></i>
            </div>
            <div class="donation-info">
              <div class="donation-title">${donation.project.title}</div>
              <div class="donation-meta">
                ${donation.fund.name} &bull;
                <span class="badge badge-${donation.status}">${getStatusLabel(donation.status)}</span>
              </div>
              ${donation.status === 'confirmed' ? `
                <div class="donation-actions">
                  <button onclick="baixarComprovante('${donation.id}')" class="btn-download comprovante">
                    <i class="fas fa-file-pdf"></i> Comprovante
                  </button>
                  ${donation.receipt_file_path ? `
                    <a href="${donation.receipt_file_path}"
                       class="btn-download recibo" target="_blank">
                      <i class="fas fa-receipt"></i> Recibo Oficial
                    </a>
                  ` : ''}
                </div>
              ` : ''}
            </div>
            <div class="donation-amount">
              <div class="donation-value">${utils.formatCurrency(donation.donation_amount)}</div>
              <div class="donation-date">${utils.formatDate(donation.created_at)}</div>
            </div>
          </div>
        `).join('');

        // Update available amount
        if (irData && irData.limites_doacao) {
          const available = irData.limites_doacao.total_maximo - response.summary.total_donated;
          document.getElementById('irDisponivel').textContent = utils.formatCurrency(Math.max(0, available));
        }

      } catch (error) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-exclamation-circle"></i>
            <h3>Erro ao carregar</h3>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    // Init
    updateUserUI();
    updateIRSummary();
    loadUserData();
    loadDonations();
  </script>
  <script src="js/tenant.js"></script>
</body>
</html>
